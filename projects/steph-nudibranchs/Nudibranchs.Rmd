---
title: "Nudibranch SDM"
author: "Stephanie Woolley"
date: "27/11/2022"
output: TBD
---

OVERALL SPECIES DISTRIBUTION MODEL
Install packages and configure email 
```{r}
#install.packages("galah")
library(dplyr)
library(galah)
library(stars)
library(ozmaps) 
library(SSDM) 
library(sdmpredictors)
library(ggplot2)
library(viridis)

galah_config(email = "z5284998@ad.unsw.edu.au" ) 
```

Download observations 
```{r}
obs <- galah_call() |>                               
  galah_identify("Nudibranchia") |>   
  galah_filter(profile = "ALA") |>
  galah_filter(country == "Australia") |>
  atlas_occurrences() 
```

format to contain only latitude and longitude
```{r}
sightings <- obs|> 
  filter(!is.na(decimalLatitude) & !is.na(decimalLongitude)) |>
  select(LATITUDE = decimalLatitude, LONGITUDE = decimalLongitude) 

#clean data to remove duplicate rows ( i dont know if i need this)
duplicates <- duplicated(sightings[c("LATITUDE", "LONGITUDE")])
occurrences <- sightings[!duplicates,]
```

Download and format environmental variable rasters
```{r}
datasets <- list_datasets(terrestrial = FALSE, marine = TRUE) 

env <- load_layers( layercodes = c("MS_biogeo08_sss_mean_5m", "MS_biogeo13_sst_mean_5m", "MS_biogeo05_dist_shore_5m", "MS_bathy_5m") , equalarea=FALSE, rasterstack=TRUE)

aus.ext <- raster::extent(110, 155, -45, -10) #create extent to limit by 

australia <- raster::crop(env, aus.ext) #limit env by the extent to get just environmental variables for just Australia
```

run SDM model with observations and environment datasets
```{r}
SDM_GLM <- modelling("GLM",
                     Occurrences = occurrences,
                     Env = australia,
                     Xcol = 'LONGITUDE', Ycol = 'LATITUDE', verbose = FALSE) 

SDM_MARS <- modelling("MARS",
                      Occurrences = occurrences %>% 
                        sf::st_drop_geometry(),
                      Env = australia,
                      Xcol = 'LONGITUDE', Ycol = 'LATITUDE', verbose = FALSE)

SDM_CTA <- modelling("CTA",
                     Occurrences = occurrences %>% 
                       sf::st_drop_geometry(),
                     Env = australia,
                     Xcol = 'LONGITUDE', Ycol = 'LATITUDE', verbose = FALSE)

combined <- -2 * (log(SDM_MARS@projection) + log(SDM_GLM@projection) + log(SDM_CTA@projection))

func <- function(x){
  1 - pchisq(q = x, df = 6)
}

combined_pval <- raster::calc(combined, fun = func)

species_distribution <- stars::st_as_stars(combined_pval)

```

plot SDM
```{r}

#download Australian map 
map <- ozmap_data(data = "states") |>
  st_transform(crs = st_crs("WGS84")) 

#plot everything together
ggplot() +
  geom_stars(data = species_distribution) +
  geom_sf(data = map) + scale_fill_viridis_c()  
```

Starting to make the initial map pretty
```{r}
ggplot() +
  geom_stars(data = species_distribution) +
  geom_sf(data = map) + scale_fill_viridis_c()  + coord_sf(crs = "WGS84", clip = "off",
           xlim = c(120, 155),
           ylim = c(-45, -11)) +
 theme_void() + labs(fill = "Probability")

```


MONTHLY SDM FOR ANIMATION 
trying to get monthly obs of species distribution

Download occurrences
```{r}
library(lubridate)
library(purrr)
library(dplyr)
library(galah)
library(stars)
library(ozmaps) 
library(SSDM) 
library(sdmpredictors)
library(ggplot2)
library(viridis)

galah_config(email = "z5284998@ad.unsw.edu.au" ) 

#get observations 
obs <- galah_call() |>                               
  galah_identify("Nudibranchia") |>   
  galah_filter(profile = "ALA") |>
  galah_filter(country == "Australia") |>
  atlas_occurrences() 

#clean, filter and convert time series to months 
sightings <- obs|> 
  filter(!is.na(decimalLatitude) & !is.na(decimalLongitude)) |>
  mutate(eventDate = ymd_hms(eventDate), 
         year = year(eventDate),
  month = month(eventDate)) |>
 select(month,  Latitude = decimalLatitude, Longitude = decimalLongitude) 

#remove duplicates (figure out if it's needed!)
duplicates <- duplicated(sightings[c("Latitude", "Longitude")])
occurrences <- sightings[!duplicates,]

```

function to filter data to each month 

```{r}
make_months <- function(chosen_month) {
  
  # filter data
  monthly_data <- occurrences %>% filter(month == {{chosen_month}}) %>%
    select(Latitude, Longitude)
}

months_list <- c(1:12)

month_list <- map(months_list, make_months)

month_list[[1]]#check to make sure it worked
```

load in environmental variables 
```{r include=FALSE}
env <- load_layers( layercodes = c("MS_biogeo08_sss_mean_5m", "MS_biogeo13_sst_mean_5m", "MS_biogeo05_dist_shore_5m", "MS_bathy_5m") , equalarea=FALSE, rasterstack=TRUE)

aus.ext <- raster::extent(110, 155, -45, -10) #create extent to limit by 

australia <- raster::crop(env, aus.ext) #limit env variables to australia
```

Build 2 functions for the model 
```{r echo=TRUE}
#function as part of the model
func <- function(x){
  1 - pchisq(q = x, df = 6)
}

#function for the model itself
make_model <- function(chosen_month) {
 
    SDM_GLM <- modelling("GLM",
                     Occurrences = (chosen_month),
                     Env = australia,
                     Xcol = 'Longitude', Ycol = 'Latitude', verbose = FALSE) 
  
     SDM_MARS <- modelling("MARS",
                      Occurrences = (chosen_month) %>% 
                        sf::st_drop_geometry(),
                      Env = australia,
                      Xcol = 'Longitude', Ycol = 'Latitude', verbose = FALSE)

     SDM_CTA <- modelling("CTA",
                     Occurrences = (chosen_month) %>% 
                       sf::st_drop_geometry(),
                     Env = australia,
                     Xcol = 'Longitude', Ycol = 'Latitude', verbose = FALSE)

combined <- -2 * (log(SDM_MARS@projection) + log(SDM_GLM@projection) + log(SDM_CTA@projection))
combined_pval <-raster::calc(combined, fun = func)
species_dis <- stars::st_as_stars(combined_pval)

#his ggplot works but I would rather it be two separate functions
p <-  ggplot() +
  geom_stars(data = species_dis)  + 
  geom_sf(data = ozmaps::ozmap_country) + scale_fill_viridis_c()
   
  return(p)
}
 
#apply function to data list
model_list <- map(month_list, make_model) 

model_list[1:12]

```

create function for plot (not working)
```{r}
plot_func <- function(chosen_month){
  p <-  ggplot() +
  geom_stars(data = chosen_month)  + #THIS PART DOESN"T WORK (but works in one function with the modelling)
  geom_sf(data = ozmaps::ozmap_country)
   
  return(p)
}

#apply function to data list
maps_list <- map(month_list, plot_func)

maps_list[[1]]

```

starting to look at a  way to make an animation 
```{r}
#install.packages("animation")
library(animation)

animation::saveGIF( #This doesn't work 
  expr = {
    model_list[1]
    model_list[2]
    model_list[3]
    model_list[4]
  
  },
  movie.name = "SMD.gif"
)

```




