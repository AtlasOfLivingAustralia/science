---
title: "Research Impact summary"
format: 
  dashboard:
    logo: ALA_Logo_Inline_REV-RGB.png
    orientation: rows
    theme: theme.scss
---


```{r}
#| message: false
#| warning: false
#| echo: false
library(here)
library(tidyverse)
library(janitor)
library(lubridate)
```

<!-- Data lives here: https://csiroau.sharepoint.com/:x:/r/sites/AtlasofLivingAustraliaTeams/Shared%20Documents/Teams/Science%20and%20Decision%20Support/Projects/publication-tracker/zoterocsv_publication-tracker/2025/2025-03-05_publications.csv?d=w6116f4bd2af841b1ab3bc08631b1a234&csf=1&web=1&e=5jID3a -->

```{r}
#| message: false
#| warning: false
#| echo: false
data <- read_csv(here("projects", "literature-tracking", "data", "2025-03-05_publications.csv"))
```

```{r cleaning}
#| message: false
#| warning: false
#| echo: false

remove <- c("1 - ", "2 - ", "3 - ", "4 - ", "5 - ", "6 - ") # list numbers you want removed

dataclean <- data |>
  janitor ::clean_names() |>
  mutate(
    date_added_clean = as_date(date_added),
    date_added_month = month(date_added_clean),
    date_added_year = year(date_added_clean)
    ) |>
  select(title, date, place, publication_year, publication_title, item_type, url, manual_tags, date_added, date_added_clean, date_added_month, date_added_year)

# remove prefix number from tags
dataclean <- dataclean |> 
  mutate( 
    tags = str_remove_all(manual_tags, 
                          paste(remove, collapse = "|"))
  )


### For tag filtering ###

# separate manual tags into separate rows (multiple entries for one paper if inc. many tags)
ALA_tags <- dataclean %>%
  mutate(tags = strsplit(as.character(tags), ";")) %>% # split names where there is a semicolon
  unnest(tags) # make them occupy multiple rows

# trim whitespace from tags
ALA_tags <- ALA_tags %>% # remove numbers
  mutate(
    tags = str_trim(tags) # trim whitespace around string 
  )
```

```{r}
#| message: false
#| warning: false
#| echo: false
# Total number of publications that cite the ALA (all time)
totalpublications <- nrow(dataclean)
```


```{r}
#| message: false
#| warning: false
#| echo: false
#number of journal articles that cite the ALA (all time)
cited_papers <- ALA_tags |>
  filter(tags == "ALA cited",
         item_type == "journalArticle")
```

```{r}
#| message: false
#| echo: false
#| warning: false
# number of papers that use ALA data (all time)
used_papers <- ALA_tags |>
  filter(tags == "ALA used", 
         item_type == "journalArticle")
```

```{r}
#| include: false
#| message: false
#| warning: false
#| echo: false
cited_used_papers <- ALA_tags |>
  filter(tags == "ALA used" | tags == "ALA cited", 
         item_type == "journalArticle") |>
  filter(!duplicated(title))

nrow(cited_used_papers)
# number of papers that either cite or use the ALA (all time)
# cited_used_papers <- nrow(cited_papers) + nrow(used_papers)
```



```{r}
#| message: false
#| warning: false
#| echo: false
#number of reports that cite the ALA (all time)
cited_reports <- ALA_tags |>
  filter(tags == "ALA cited") |> 
  filter(item_type == "report")
```


```{r}
#| message: false
#| echo: false
#| warning: false
# number of reports that use ALA data (all time)
used_reports <- ALA_tags |>
  filter(tags == "ALA used") |>
  filter(item_type == "report")
```


```{r}
#| include: false
#| message: false
#| warning: false
#| echo: false

cited_used_reports <- ALA_tags |>
  filter(tags == "ALA used" | tags == "ALA cited", 
         item_type == "report") |>
  filter(!duplicated(title))


# number of reports that either cite or use the ALA (all time)
cited_used_reports <- nrow(cited_reports) + nrow(used_reports)
```




```{r}
#| message: false
#| warning: false
#| echo: false
topic_tags <- c("AGRICULTURE", "BIODIVERSITY SCIENCE", "BIOGEOGRAPHY", 
                "CITIZEN SCIENCE", "CLIMATE CHANGE", "CONSERVATION", 
                "DATA MANAGMENT", "DNA", "ECOLOGY", "ECOSYSTEM SERVICES", 
                "EVOLUTION", "INVASIVE SPECIES", "MARINE", "PHYLOGENETICS", 
                "SPECIES DISTRIBUTION", "TAXONOMY")

tag_counts <- ALA_tags |>
  group_by(tags) |>
  summarise(count = n()) 

filtered_tags <- tag_counts %>%
  filter(tags %in% topic_tags)

total_tags <- sum(filtered_tags$count)
```

```{r}
#| echo: false
percents <- filtered_tags %>%
  mutate(
    perc = (count / total_tags) * 100,
    perc_label = paste0(round(perc, 2), "%")
    )

# numeric_percentages <- as.numeric(sub("%", "", percents$perc))

# Sum the numeric percentages
total_sum <- sum(percents$perc)
```

```{r}
#| message: false
#| warning: false
#| echo: false
percents <- percents %>%
  mutate(tags = reorder(tags, count))
```

```{r}
#| message: false
#| warning: false
#| echo: false
top_10 <- percents %>%
  top_n(10, wt = count)
```


```{r}
# Repeat steps above but for last year only 
dataclean_2024 <- dataclean |> 
  filter(date_added_clean >= ymd("2024-01-01")) |>
  filter(date_added_clean <= ymd("2024-12-31")) |>
  filter(publication_year == c("2024")) 
```

```{r}
#| message: false
#| warning: false
#| echo: false
## Filtering Tags

# separate manual tags into separate rows (multiple entries for one paper if inc. many tags)
ALA_tags_2024 <- dataclean_2024 %>%
  mutate(tags = strsplit(as.character(tags), ";")) %>% # split names where there is a semicolon
  unnest(tags) # make them occupy multiple rows

# trim whitespace from tags
ALA_tags_2024 <- ALA_tags_2024 %>% # remove numbers
  mutate(
    tags = str_trim(tags) # trim whitespace around string 
  )
```

```{r}
#| message: false
#| warning: false
#| echo: false
#number of *papers* that cite the ALA in last year
cited_papers_year <- ALA_tags |>
  filter(tags == "ALA cited") |>
  filter(item_type =="journalArticle")

# number of *papers* that use the ALA in last year
used_papers_year <- ALA_tags |>
  filter(tags == "ALA used") |>
  filter(item_type == "journalArticle") 

# *papers or journal articles* cited and used in last year
used_cited_papers <- ALA_tags |>
  filter(tags == "ALA used" | tags == "ALA cited",
         item_type == "journalArticle") |>
  filter(!duplicated(title)) |>
  nrow()

used_cited_papers_year <- ALA_tags_2024 |>
  filter(tags == "ALA used" | tags == "ALA cited",
         item_type == "journalArticle") |>
  filter(!duplicated(title)) |>
  nrow()

# used_cited_papers_year <- nrow(used_papers_year) + nrow(cited_papers_year)
```

```{r}
#| message: false
#| echo: false
#| warning: false
# number of *reports* that use the ALA in last year
used_reports_year <- ALA_tags |>
  filter(tags == "ALA used") |>
  filter(item_type == "report") 

#number of *reports* that cite the ALA in last year
cited_reports_year <- ALA_tags |>
  filter(tags == "ALA cited") |>
  filter(item_type =="report")

# *reports* cited and used in the last year
used_cited_reports <- ALA_tags |>
  filter(tags == "ALA used" | tags == "ALA cited",
         item_type == "report") |>
  filter(!duplicated(title)) |>
  nrow()

used_cited_reports_year <- ALA_tags_2024 |>
  filter(tags == "ALA used" | tags == "ALA cited",
         item_type == "report") |>
  filter(!duplicated(title)) |>
  nrow()

# used_cited_reports_year <- nrow(cited_reports_year) + nrow(used_reports_year)
```

## Row {height=10%}

```{r}
#| content: valuebox
#| title: "Total citations"

totalpub <- totalpublications |> scales::comma()

list(
  icon = "book-half",
  color = "#EEECEA",
  value = totalpub
)
```


```{r}
#| content: valuebox
#| title: "Journal articles (Used/Cited ALA)"

totalarticles <- used_cited_papers |> scales::comma()

list(
  color = "#C3EDEF",
  value = totalarticles
)
```



```{r}
#| content: valuebox
#| title: "2024 Journal articles (Used/Cited ALA)"

articles2024 <- used_cited_papers_year |> scales::comma()

list(
  color = "#C3EDEF",
  value = articles2024
)
```


```{r}
#| content: valuebox
#| title: "Reports (Used/Cited ALA)"

totalreports <- used_cited_reports |> scales::comma()

list(
  color = "#FFEDCF",
  value = totalreports
)
```


```{r}
#| content: valuebox
#| title: "2024 Reports (Used/Cited ALA)"

reports2024 <- used_cited_reports_year |> scales::comma()

list(
  color = "#FFEDCF",
  value = reports2024
)
```

## Row {height=70%}
### Column {width=50%}

```{r}
#| title: "Journal articles by year (Used or Cited only)"

publication_counts <- ALA_tags |>
  filter(tags == "ALA used" | tags == "ALA cited",
         item_type == "journalArticle") |>
  filter(!duplicated(title)) |> # remove duplicate titles
  drop_na(publication_year) |>
  count(publication_year)

pubsyearbargraph <- ggplot(publication_counts, 
                           aes(x = as.factor(publication_year), 
                               y = n)
                           ) + 
  geom_bar(stat = "identity", size = 0.5, width = 0.98, fill = "#1B5D81") + 
  labs(x = "Year", 
       y = "Number of journal articles") +
  pilot::theme_pilot(grid = "h") +
  scale_y_continuous(expand = c(0, 0),
                     limits = c(0, 250)) +
  scale_x_discrete(breaks = c(2007, 2009, 2011, 2013, 2015, 2017, 2019, 2021, 2023, 2025)) +
  labs(caption = "*TOTAL JOURNAL ARTICLES CITING OR USING ALA DATA") +
  theme(
    panel.grid = element_blank(),
    axis.line.y = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.text = element_text(size = 8),
    legend.key.width = unit(1, 'mm')) 
pubsyearbargraph
```


```{r}
#| message: false
#| warning: false
#| echo: false
custom_palette <- c("#003A70", "#6CDE4B", "#DE4BC3", "#F26649", "#E0AA51", "#895C81", "#667073", "#691C32", "#6BDAD5", "#B7CD96")
```


```{r}
#| message: false
#| warning: false
#| echo: false

library(pilot)
library(ggfittext)
litsum <- extrafont::loadfonts(device = "win", quiet = TRUE)
theme_set(theme_minimal(base_family = "Roboto"))
showtext::showtext_auto()
showtext::showtext_opts(dpi = 200)

litsum <- ggplot(top_10, aes(x = count, y = tags)) +
  geom_col(fill = custom_palette) +
  # geom_text(
  #   aes(label = paste(tags)),
  #   position = position_nudge(x = -0.5),
  #   hjust = 1,
  #   vjust = 0.5,  # Center the label vertically
  #   color = "white", size = 5, fontface = "bold") +  # Adjust text color, size, and fontface for bold
  geom_bar_text(aes(label = paste(tags)),
                # position = position_nudge(x = -0.5),
                # hjust = 1,
                # vjust = 0.5,  # Center the label vertically
                min.size = 3, 
                outside = FALSE,
                family = "Roboto", 
                colour = "white",
                fontface = "bold") +
  geom_text(
    aes(label = paste(perc_label)),
    position = position_nudge(x = 0.5),
    hjust = -0.2,
    vjust = 0.5,  # Center the label vertically
    color = "grey30", size = 5, fontface = "bold") +  # Adjust text color, size, and fontface for bold
  xlim(c(0, max(top_10$perc) + 80)) +
  theme_pilot(axes = "",
              grid = "",
              legend_position = "none") + # Set font family, text color, and bold
  scale_fill_manual(values = custom_palette) + 
  labs(caption = "*TOPICS OF PUBLISHED ARTICLES (2024)") +
  theme(axis.text.x = element_blank(),  
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank())  
```


```{r}
#| title: Journal article topics 2024
#| echo: false
plot(litsum)
```






### Column (width=50%)

```{r}
#| include: false
#| message: false
#| warning: false
#| echo: false
# change the date range of the tag code so it can be used again but this time across all years and for ALA tools 
dataclean_all <- dataclean |> 
  filter(date_added_clean >= ymd("2007-01-01")) |>
  filter(date_added_clean <= ymd("2025-12-31"))
```

```{r}
#| include: false
#| message: false
#| warning: false
#| echo: false
## Filtering Tags

# separate manual tags into separate rows (multiple entries for one paper if inc. many tags)
ALA_tags <- dataclean_all %>%
  mutate(tags = strsplit(as.character(tags), ";")) %>% # split names where there is a semicolon
  unnest(tags) # make them occupy multiple rows

# trim whitespace from tags
ALA_tags <- ALA_tags %>% # remove numbers
  mutate(
    tags = str_trim(tags) # trim whitespace around string 
  )
```



```{r}
#| include: false
#| message: false
#| warning: false
#| echo: false

selected_tool_tags <- c("Species occurrence records", "galah", "Spatial Portal", "Species lists", "Profiles", "Climate Data", "Images", "Survey Planning", "AusTraits", "APPD", "AVH", "BioCollect", "Digivol", "Sensitive Data Service SDS", "Modelling", "Phylolink", "Habitat Condition Assessment Tool", "delta")

# ALA_tags |>
#   filter(tags %in% "Habitat Condition Assessment Tool")

pubs_by_year <- dataclean |>
  filter(publication_year > 2006,
         item_type == "journalArticle") |>
  group_by(publication_year) |>
  count()

tool_tag_counts <- ALA_tags |>
  filter(item_type == "journalArticle",
         tags %in% selected_tool_tags) |>
  group_by(tags, publication_year) |>
  summarise(tag_count = n()) 

# join counts
tags_by_year <- tool_tag_counts |>
  left_join(pubs_by_year) |>
  rename(total_publications = n) |>
  group_by(publication_year) |>
  mutate(nil_tags = total_publications - sum(tag_count)) # add nil tags
```


```{r}
#| title: Tools cited in the publication tracker (bar plot)
#| echo: false

tagsplot <- ggplot(tags_by_year, aes(x = publication_year, y = tag_count, fill = tags)) + 
  geom_bar(stat = "identity", position = "stack", linewidth = 0.5, width = 0.98) + 
  labs(x = "", 
       y = "Total papers tagged") +
  pilot::theme_pilot(grid = "h") +
  scale_y_continuous(expand = c(0, 0)) +
  scale_x_discrete(breaks = c(2007, 2009, 2011, 2013, 2015, 2017, 2019, 2021, 2023, 2025)) +
  scale_fill_pilot(palette = "seven", discrete = TRUE, reverse = FALSE) + 
  #labs(caption = "*NO. OF JOURNAL ARTICLES BY YEAR") +
  theme(
    panel.grid = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.text = element_text(size = 8),
    legend.key.width = unit(1, 'mm')) 

```


```{r}
#| eval: false
ggsave(tagsplot, file = here::here("stacked-tags-bar-plot.png"),
       height = 7, width = 10)
```

```{r}
piccia_palette <- c(
  purple = "#5c1c8d",
  lilac = "#be77bf",
  dark_pink = "#cd0d72",
  light_pink = "#f76bcc",
  orange = "#b4612b",
  emerald = "#3ca465",
  forest_green = "#1c4d3b",
  blue_grey = "#55517e",
  soft_coral = "#FF6F61",
  seafoam_green = "#A8E6CF",
  dusty_lavender = "#B49CC2",
  muted_gold = "#D4AF37",
  slate_blue = "#6A7F9B",
  burnt_sienna = "#E97451",
  soft_peach = "#FAD02E",
  charcoal_grey = "#333333",
  periwinkle_blue = "#8E9BFF",
  mint_green = "#98FF98"
)
```

<!-- Dax: What is this theme? I don't see it anywhere. If it's not being used, delete it-->

```{r}
theme_piccia <- function() {
  
  theme_minimal(base_size = 12) +
    # Align the font with the rest of the page
    theme(text = element_text(family = "Roboto", colour = "#12051C"),
          # Make the title the main thing, and make it wrap to the width of the plot
          # by putting it inside a textbox
          plot.title = ggtext::element_textbox_simple(face = "bold", size = rel(1.5),
                                                      margin = margin(12, 0, 12, 0, "pt")),
          axis.text = element_text(family = "Roboto", colour = "#372D40"),
          panel.grid = element_line(colour = "#FFFFFF"),
          panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank(),
          axis.title = element_blank(),
          plot.background = element_rect(colour = "#F7F4F6", fill = "#F7F4F6"),
          # Give everything a bit more space
          plot.margin = margin(rep(12, 4)))
}
```


```{r, fig.width=20, fig.height=20}
#| title: "ALA tool use in published journal articles"

tags_by_year <- tags_by_year |>
  filter(publication_year != 2025) 


tagslineplot <- 
  tags_by_year |>
  ggplot(aes(x = publication_year,
             y = tag_count,
             colour = tags,
             group = tags)) +  
  geom_line(linewidth = 4,
            alpha = 0.85) +
  scale_y_log10(expand = c(0, 0)) +  
  # scale_x_discrete(breaks = c(2006, 2008, 2010, 2012, 2014, 2016, 2018, 2020, 2022, 2024)) + 
  gghighlight::gghighlight(
    unhighlighted_params = list(alpha = 0.3,
                                linewidth = 0.5,
                                colour = piccia_palette[["blue_grey"]]),
    label_params = list(size = 10)
  ) +     
  facet_wrap(vars(tags), nrow = 6, ncol = 3) +
  pilot::theme_pilot(grid = "h") +
  # coord_fixed(ratio = 6) +  
  labs(y = expression("Number of Journal Articles (log"[10]*")"),
       x = "Publication year") +
  theme(strip.text = element_blank(),
        axis.title = element_text(size = 20),
        axis.text = element_text(size = 16),
        axis.text.x = element_text(size = 16))


tagslineplot


```


```{r}
#| include: false
tags_by_year |>
  filter(tags %in% c("delta", "Sensitive data service", "Habitat Condition Assessment Tool", "AusTraits"))
```


```{r}
# save
ggsave("tags_lineplot.png", plot = tagslineplot, width = 16, height = 10)
```







