---
title: "geocoding_records"
format: html
editor: visual
---

## Geocoding

```{r}
#load libraries
library(tidyverse)
library(tmaptools)
```

Read CSV file into dataframe, and melt it so that each observation is granted its own row, and make a new place column for use by tmaptools::geocode_OSM

```{r}
#df <- read.csv("your/file/path/here.csv")
df <- read.csv("data_in/trichoglossus_haematodus_azlin_complete.csv")

#add place column as required by some geocoder functions
df$place <- paste(df$location, df$state, df$country, sep = ", ")
```

Some locations may include distances, for example '100km north of sydney' - remove these into a different df and run geocoder on remaining records

```{r}
#id entries with 'km ' within it, subset into different df
has_km <- grepl("km ", df$location)

#new df for entries that include distances
km_df <- subset(df, has_km)

#geocode locations - excluding those which include 'km' in record
result <- geocode_OSM(df[!has_km, ]$place, keep.unfound = TRUE)

No results found for "Lake Kutubu and Herzog Mountains, , New Guinea".
No results found for "Bernhard Camp to Sepik and Wahgi Valley, , New Guinea".

geocode_OSM('Ford, Queensland, Australia') #works
geocode_OSM('Cooktown, Queensland, Australia') #works
geocode_OSM('Mt Forest, Queensland, Australia') #fails
geocode_OSM('Nebo, Queensland, Australia') #works

No results found for "South Cooktown- Mt Forest area - Ford, Queensland, Australia".
No results found for "Gap Creek 40 miles south of Cooktown, Queensland, Australia".
No results found for "North Nebo, Queensland, Australia".
No results found for ", Timor, Indonesia/East Timor".
No results found for "New Hanover Island, Bismarck Archipelago, New Guinea".
No results found for "Santa Cruz Island, , Vanuatu".
No results found for "Utingu, Queensland, Australia".
No results found for "Lynd River / Pinnacle Creek, Queensland, Australia".
No results found for "Mount Sapphire, Queensland, Australia".
No results found for "Coomooboolaroo, Queensland, Australia".
No results found for "Utingu, Queensland, Australia".
No results found for "Mount Sapphire, Queensland, Australia".
No results found for "Kloofbivak, , Indonesia".
No results found for "Koerik, , Indonesia".
No results found for "Maprik, , New Guinea".
No results found for "Ambunti, , New Guinea".
No results found for "Hunstein River Valley, , New Guinea".
No results found for "Uinba, , New Guinea".
No results found for "Nowata, , New Guinea".
No results found for "Barakau, , New Guinea".
No results found for "Putei, , New Guinea".
No results found for "Ravikivau, , New Guinea".
No results found for "Herzog, , New Guinea".
No results found for "Mindik, , New Guinea".
No results found for "Agevairu, , New Guinea".
No results found for "Hunstein River Valley, , New Guinea".
No results found for "Ihu, , New Guinea".
No results found for "Agevairu, , New Guinea".
No results found for "Barakau, , New Guinea".
No results found for "Sogeri, , New Guinea".
No results found for "Rigo, , New Guinea".
No results found for "Brown River, , New Guinea".
No results found for "Nowata, , New Guinea".
No results found for "Herzog/Wagau, , New Guinea".
No results found for "Mindik, , New Guinea".
No results found for "Bensbach/Morehead, , New Guinea".
No results found for "Lake Daviumbu, , Papua New Guinea".
No results found for "Wassi Kussa River, , New Guinea".
No results found for "Oriomo River, , Papua New Guinea".
No results found for "Kaloa Toa, Sulawesi, Indonesia".
No results found for "Seram Island, Maluku Islands, Indonesia".
No results found for "Buru Island, Maluku Islands, Indonesia".
No results found for "Teoor Island, Maluku Islands, Indonesia".
No results found for "Gorong Islands, Maluku Islands, Indonesia".
No results found for "Kisoei, , Indonesia".
No results found for "Misod, , ".
No results found for "Wandammen Peninsula, , New Guinea".
No results found for "Torricelli Mountains, , Papua New Guinea".
No results found for "Kanganaman, , Papua New Guinea".
No results found for "Wondgl, , ".
No results found for "Adelbert Mountains, , Papua New Guinea".
No results found for "Finisterre Range, , Papua New Guinea".
No results found for "Seram Island, Maluku Islands, Indonesia".
No results found for "Buru Island, Maluku Islands, Indonesia".
No results found for "Kisoei, , Indonesia".
No results found for "Misod, , ".
No results found for "Monokwari, , Indonesia".
No results found for "Finisterre Range, , Papua New Guinea".
No results found for "Aikora River, , Papua New Guinea".
No results found for "Hydrographers Range, , Papua New Guinea".
No results found for "Mafulu, , Papua New Guinea".
No results found for "Vanamai, , Papua New Guinea".
No results found for "Aikora River, , Papua New Guinea".
No results found for "Upper Setaki, , ".
No results found for "Sudirman Range, , Indonesia".
No results found for "Black and Palmer River junction, Queensland, Australia".
No results found for "Kubuna/Kubena, , ".
No results found for "Misori, , Indonesia".
No results found for "Bonoo Bonoo National Park, New South Wales, Australia".
No results found for "Gilbert River Crossing, , Australia".
No results found for "Morehead River Crossing, Queensland, Australia".
No results found for "Kalpowar Station, Queensland, Australia".
No results found for "Between Morehead and Hann Rivers, Queensland, Australia".
No results found for "Between Cairns and Port Douglas, Queensland, Australia".
No results found for "Claudiah , Queensland, Australia".
No results found for "Cairns / Atherton, Queensland, Australia".
No results found for "Teatree Gully, South Australia, Australia".
No results found for "Mount Tambourine, Queensland, Australia".
No results found for "Ten Mile Gap Rd Shoalwater Bay, Queensland, Australia".
No results found for "Blackwood SA Sturt River, South Australia, Australia".
No results found for "Bellinger River, Queensland, Australia".
No results found for "Nth Suburbs Sydney, New South Wales, Australia".
No results found for "Avalon, unclear, Australia".
No results found for "Burdekin Gap (Townsville region) 20 to 24degrees South Gladstone, Queensland, Australia".
No results found for "Victoria River District, Northern Territory, Australia".
No results found for "Arnhem Land to Gulf of Carpentaria, , Australia".
No results found for "S Gulf of Carpentaria Roper and Nicholson Rivers, , Australia"
No results found for "Hunter to S Monaro / Murray River, Victoria, Australia".
No results found for "Gayndah (Burnett River), Queensland, Australia".
No results found for "Astonville, , Australia".
geocode_OSM('Blackheath, New South Wales, Australia')
```

For entries including kilometers, split distance, direction, and base location and geocode

```{r}
#make new columns splitting distance, direction, and location 
km_df$distance <- sub("km .*", "", km_df$place)
km_df$direction <- sub(".*km ([A-Za-z]+).*", "\\1", km_df$place)
km_df$loc <- sub(".*km [A-Za-z]+ (.*)", "\\1", km_df$place)

for (row in 1:nrow(km_df)) {
  base_location <- km_df[row, "loc"]
  distance_km <- as.numeric(sub("km", "", km_df[row, "distance"]))
  direction <- km_df[row, "direction"]
  
  # Geocode the base location
  base_coordinates <- geocode_OSM(base_location)
  if (is.null(base_coordinates) || length(base_coordinates) == 0) {
    # Skip iteration if geocoding result is empty
    next
  }
  
  # Calculate the new coordinates based on direction and distance
  if (direction == "N") {
    new_latitude <- base_coordinates$coords[2] + (distance_km / 111)
    new_longitude <- base_coordinates$coords[1]
  } else if (direction == "S") {
    new_latitude <- base_coordinates$coords[2] - (distance_km / 111)
    new_longitude <- base_coordinates$coords[1]
  } else if (direction == "E") {
    new_latitude <- base_coordinates$coords[2]
    new_longitude <- base_coordinates$coords[1] + (distance_km / (111 * cos(base_coordinates$coords[2] * pi / 180)))
  } else if (direction == "W") {
    new_latitude <- base_coordinates$coords[2]
    new_longitude <- base_coordinates$coords[1] - (distance_km / (111 * cos(base_coordinates$coords[2] * pi / 180)))
  } else if (direction == "NE") {
    new_latitude <- base_coordinates$coords[2] + (distance_km / 111)
    new_longitude <- base_coordinates$coords[1] + (distance_km / (111 * cos(base_coordinates$coords[2] * pi / 180)))
  } else if (direction == "NW") {
    new_latitude <- base_coordinates$coords[2] + (distance_km / 111)
    new_longitude <- base_coordinates$coords[1] - (distance_km / (111 * cos(base_coordinates$coords[2] * pi / 180)))
  } else if (direction == "SE") {
    new_latitude <- base_coordinates$coords[2] - (distance_km / 111)
    new_longitude <- base_coordinates$coords[1] + (distance_km / (111 * cos(base_coordinates$coords[2] * pi / 180)))
  } else if (direction == "SW") {
    new_latitude <- base_coordinates$coords[2] - (distance_km / 111)
    new_longitude <- base_coordinates$coords[1] - (distance_km / (111 * cos(base_coordinates$coords[2] * pi / 180)))
  } else {
    # Handle any other direction values here (if needed)
    new_latitude <- NA
    new_longitude <- NA
  }
  
  # Assign the new latitude and longitude to the dataframe
  km_df[row, "lat"] <- new_latitude
  km_df[row, "lon"] <- new_longitude
}
```

Adding longitude latitude values into df & write csv

```{r}
#creat lat lon columns in df
df$lat <- NA
df$lon <- NA


#apply lat lon from geocoder to non-km rows
df[!has_km, ]$lat <- result$lat
df[!has_km, ]$lon <- result$lon

#apply lat lon from geocoder for km-rows
df[has_km, ]$lat <- km_df$lat
df[has_km, ]$lon <- km_df$lon

#see how many NAs - need to go back and find solution for these (ie enter more findable location for geocoder)
sum(is.na(df$lat))

df <- uncount(df, weights = n_records) 

#write csv
write.csv(df, file="data_out/trichoglossus_points.csv")
```

## Mapping

```{r}
#all packages
library(rnaturalearth)
library(tidyverse) 
library(here)
library(rmapshaper)
library(ggpointdensity)
library(viridis)
library(concaveman) 
library(cowplot)
library(patchwork)
library(sf) 
library(ggplot2)
library(scales)
```

```{r}
filename <- ne_download(scale = 10, 
                        type = "countries",
                        returnclass = "sf",
                        destdir = "shapefiles",
                        load = FALSE)

# import downloaded shapefile
shapefile <- paste0("shapefiles/", filename, ".shp") |>
  st_read()

#import points
df <- read.csv("data_out/trichoglossus_points.csv")

#plot - success!
ggplot() + 
  geom_sf(data = shapefile, colour = "black", fill = NA) + 
  geom_point(data = df, mapping = aes(x = lon, y = lat), colour = "red") + 
  coord_sf()
```

### All Points

```{r}
#all points map
df_points_map <- ggplot() +
  geom_pointdensity(data = df,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Number of \noverlapping points")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(df))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

df_points_map1 <- ggplot() +
  geom_pointdensity(data = df,
                    mapping = aes(x = lon,
                                  y = lat,
                                  shape = subspecies)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  scale_shape_manual(values=c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16)) +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Number of \noverlapping points")) +
    labs(subtitle = paste("Number of observations: ", nrow(df)), title = "Trichoglossus haematodus (transcribed)") +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

ggsave('trichoglossus_plots/points_plot.png', df_points_map)
ggsave('trichoglossus_plots/points_plotshapes.png', df_points_map1)
```

### Contours

```{r}
library(ggplot2)
library(rnaturalearth)
library(sf)
library(viridis)
library(scales)

contour_plot <- ggplot() + 
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) + 
  lims(x = c(90, 185), y = c(-45, 10)) +
  geom_density_2d(df, mapping = aes(x = lon, y = lat, color = ..level..)) +
  scale_color_viridis() +
 labs(subtitle = paste("Number of observations: ", nrow(df)), title = "Trichoglossus haematodus (transcribed)", colour = "Density") +
  theme_void() +
theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left")
  
  
ggsave('trichoglossus_plots/contour_plot.png', contour_plot)
```

### Concave Hulls

There is an error here, not working

```{r}
#remove NA values
df1 <- df[complete.cases(df$lat, df$lon), ]

#delete unneccessary columns - must do this for CH to work 
df1 <- df1[ , c(2,12,13)]

#nest coordinates
df_nest <- df1 |> 
  nest(coords = c(lon, lat))

#make concave hull
subset_concave1 <- df_nest |>
    mutate(points_sf = map(.x = coords,
                           ~ st_as_sf(.x, coords = c("lon", "lat"),
                                      crs = 4326)), 
           concave_sf = map(points_sf,
                            ~ concaveman(.x)))

subset_concave1 <- subset_concave1 |> 
  select(species_name, concave_sf) |> 
  unnest(cols = c(concave_sf)) |> 
  ungroup() |> 
  st_sf(crs = 4326) 

#concave map
df_concave1 <- ggplot() + 
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +
  geom_sf(data = subset_concave1, fill = "#609966", alpha = 0.2, lwd = 0) +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
 labs(subtitle = paste("Number of observations: ", nrow(df)), title = "Trichoglossus haematodus (transcribed)") +
  theme_void() +
theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

ggsave('trichoglossus_plots/concave_plot.png', df_concave1)
```

### Filtering

```{r}
df <- df[complete.cases(df$lat, df$lon), ]

table(df$species_name)

sp_cap <- filter(df, species_name == "Trichoglossus capistratus")
sp_forst <- filter(df, species_name == "Trichoglossus forsteni")
sp_haem <- filter(df, species_name == "Trichoglossus haematodus")
sp_mol <- filter(df, species_name == "Trichoglossus moluccanus")
sp_rub <- filter(df, species_name == "Trichoglossus rubritorquis")
sp_web <- filter(df, species_name == "Trichoglossus weberi")

#sp_rosenbergii has no coords

table(sp_rub$subspecies)
table(sp_cap$subspecies) #all specimens also cap sbsp, thus included in sbsp object
table(sp_forst$subspecies)
table(sp_haem$subspecies) #has all sbsp, but not all specimens of those, some are separate species
table(sp_mol$subspecies)
table(sp_web$subspecies)#all specimens also web sbsp, thus included in sbsp object

table(df$subspecies)

none <- filter(df, subspecies == "")
caeruliceps <- filter(df, subspecies == "caeruliceps")
capistratus <- filter(df, subspecies == "capistratus")
flavicans <- filter(df, subspecies == "flavicans")
forsteni <- filter(df, subspecies == "forsteni")
fortis <- filter(df, subspecies == "fortis")
haematodus <- filter(df, subspecies == "haematodus")
intermedius <- filter(df, subspecies == "intermedius")
massena <- filter(df, subspecies == "massena")
micropteryx <- filter(df, subspecies == "micropteryx")
moluccanus <- filter(df, subspecies == "moluccanus")
moluc_x_rub <- filter(df, subspecies == "moluccanus x rubritorquis")
nom_haem <- filter(df, subspecies == "nominate haematodus")
rosenbergii <- filter(df, subspecies == "rosenbergii")
rubritorquis <- filter(df, subspecies == "rubritorquis")
weberi <- filter(df, subspecies == "weberi")

#flavitectus and mitchelli and rubritorqus x capistratus have no coords
```

### Mapping subspecies

```{r}
noneplot <- ggplot() +
  geom_pointdensity(data = none,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
    coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(none))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

caerulicepsplot <- ggplot() +
  geom_pointdensity(data = caeruliceps,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(caeruliceps))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

caplot <- ggplot() +
  geom_pointdensity(data = capistratus,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(capistratus))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

flavicansplot <- ggplot() +
  geom_pointdensity(data = flavicans,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(flavicans))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

forsteniplot <- ggplot() +
  geom_pointdensity(data = forsteni,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(forsteni))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

fortis <- filter(df, subspecies == "fortis")
fortisplot <- ggplot() +
  geom_pointdensity(data = fortis,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(fortis))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

haemplot <- ggplot() +
  geom_pointdensity(data = haematodus,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(haematodus))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

intplot <- ggplot() +
  geom_pointdensity(data = intermedius,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(intermedius))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

massplot <- ggplot() +
  geom_pointdensity(data = massena,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(massena))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

microplot <- ggplot() +
  geom_pointdensity(data = micropteryx,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(micropteryx))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

molplot <- ggplot() +
  geom_pointdensity(data = moluccanus,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(moluccanus))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

molxrubplot <- ggplot() +
  geom_pointdensity(data = moluc_x_rub,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(moluc_x_rub))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

nomhaemplot <- ggplot() +
  geom_pointdensity(data = nom_haem,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(nom_haem))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

rosplot <- ggplot() +
  geom_pointdensity(data = rosenbergii,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(rosenbergii))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

rubplot <- ggplot() +
  geom_pointdensity(data = rubritorquis,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(rubritorquis))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

webplot <- ggplot() +
  geom_pointdensity(data = weberi,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(weberi))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )
```

### Mapping Species

```{r}
#SPECIES
spcapplot <- ggplot() +
  geom_pointdensity(data = sp_cap,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(sp_cap))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

spforstplot <- ggplot() +
  geom_pointdensity(data = sp_forst,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(sp_forst))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

sphaemplot <- ggplot() +
  geom_pointdensity(data = sp_haem,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(sp_haem))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

spmolplot <- ggplot() +
  geom_pointdensity(data = sp_mol,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(sp_mol))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

sprubplot <- ggplot() +
  geom_pointdensity(data = sp_rub,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(sp_rub))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

spwebplot <- ggplot() +
  geom_pointdensity(data = sp_web,
                    mapping = aes(x = lon,
                                  y = lat)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (Schodde):", nrow(sp_web))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )
```

## GBIF

### Filtering

```{r}
gbiftri <- read.delim("GBIF/gbif_trichoglossus_haematodus_preserved/trichoglossus_haematodus_gbif_preserved.csv")

gbiftri <- gbiftri[complete.cases(gbiftri$decimalLatitude, gbiftri$decimalLongitude), ]

write.csv(gbiftri, file="trichoglossus_gbif.csv")

gbif_points_map <- ggplot() +
  geom_pointdensity(data = gbiftri,
                    mapping = aes(x = decimalLongitude,
                                  y = decimalLatitude)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Number of \noverlapping points")) +
    labs(subtitle = paste("Number of observations (GBIF):", nrow(gbiftri))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )


ggsave('trichoglossus_plots/allcombined.png', df_points_map + gbif_points_map + plot_annotation(title = "Trichoglossus haematodus (all)"))

table(gbiftri$infraspecificEpithet)

gbif_cap <- filter(gbiftri, infraspecificEpithet == "capistratus")
gbif_dep <- filter(gbiftri, infraspecificEpithet == "deplanchii")
gbif_djam <- filter(gbiftri, infraspecificEpithet == "djampeanus")
gbif_flavi <- filter(gbiftri, infraspecificEpithet == "flavicans")
gbif_flavo <- filter(gbiftri, infraspecificEpithet == "flavotectus")
gbif_forst <- filter(gbiftri, infraspecificEpithet == "forsteni")
gbif_fort <- filter(gbiftri, infraspecificEpithet == "fortis")
gbif_haem <- filter(gbiftri, infraspecificEpithet == "haematodus")
gbif_int <- filter(gbiftri, infraspecificEpithet == "intermedius")
gbif_mass <- filter(gbiftri, infraspecificEpithet == "massena")
gbif_micro <- filter(gbiftri, infraspecificEpithet == "micropteryx")
gbif_mitch <- filter(gbiftri, infraspecificEpithet == "mitchellii")
gbif_mol <- filter(gbiftri, infraspecificEpithet == "moluccanus")
gbif_neso <- filter(gbiftri, infraspecificEpithet == "nesophilus")
gbif_nigro <- filter(gbiftri, infraspecificEpithet == "nigrogularis")
gbif_ros <- filter(gbiftri, infraspecificEpithet == "rosenbergii")
gbif_rub <- filter(gbiftri, infraspecificEpithet == "rubritorquis")
gbif_sep <- filter(gbiftri, infraspecificEpithet == "septentrionalis")
gbif_web <- filter(gbiftri, infraspecificEpithet == "weberi")
```

### Mapping

```{r}
capplotgbif <- ggplot() +
  geom_pointdensity(data = gbif_cap,
                    mapping = aes(x = decimalLongitude,
                                  y = decimalLatitude)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (GBIF):", nrow(gbif_cap))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

depplotgbif <- ggplot() +
  geom_pointdensity(data = gbif_dep,
                    mapping = aes(x = decimalLongitude,
                                  y = decimalLatitude)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (GBIF):", nrow(gbif_dep))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

djamplotgbif <- ggplot() +
  geom_pointdensity(data = gbif_djam,
                    mapping = aes(x = decimalLongitude,
                                  y = decimalLatitude)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (GBIF):", nrow(gbif_djam))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

flaviplotgbif <- ggplot() +
  geom_pointdensity(data = gbif_flavi,
                    mapping = aes(x = decimalLongitude,
                                  y = decimalLatitude)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (GBIF):", nrow(gbif_flavi))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

flavoplotgbif <- ggplot() +
  geom_pointdensity(data = gbif_flavo,
                    mapping = aes(x = decimalLongitude,
                                  y = decimalLatitude)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (GBIF):", nrow(gbif_flavo))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

forstplotgbif <- ggplot() +
  geom_pointdensity(data = gbif_forst,
                    mapping = aes(x = decimalLongitude,
                                  y = decimalLatitude)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (GBIF):", nrow(gbif_forst))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

fortplotgbif <- ggplot() +
  geom_pointdensity(data = gbif_fort,
                    mapping = aes(x = decimalLongitude,
                                  y = decimalLatitude)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (GBIF):", nrow(gbif_fort))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

haemplotgbif <- ggplot() +
  geom_pointdensity(data = gbif_haem,
                    mapping = aes(x = decimalLongitude,
                                  y = decimalLatitude)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (GBIF):", nrow(gbif_haem))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

intplotgbif <- ggplot() +
  geom_pointdensity(data = gbif_int,
                    mapping = aes(x = decimalLongitude,
                                  y = decimalLatitude)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (GBIF):", nrow(gbif_int))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

massplotgbif <- ggplot() +
  geom_pointdensity(data = gbif_mass,
                    mapping = aes(x = decimalLongitude,
                                  y = decimalLatitude)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (GBIF):", nrow(gbif_mass))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

microplotgbif <- ggplot() +
  geom_pointdensity(data = gbif_micro,
                    mapping = aes(x = decimalLongitude,
                                  y = decimalLatitude)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (GBIF):", nrow(gbif_micro))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

mitchplotgbif <- ggplot() +
  geom_pointdensity(data = gbif_mitch,
                    mapping = aes(x = decimalLongitude,
                                  y = decimalLatitude)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (GBIF):", nrow(gbif_mitch))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

molplotgbif <- ggplot() +
  geom_pointdensity(data = gbif_mol,
                    mapping = aes(x = decimalLongitude,
                                  y = decimalLatitude)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (GBIF):", nrow(gbif_mol))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

nesoplotgbif <- ggplot() +
  geom_pointdensity(data = gbif_neso,
                    mapping = aes(x = decimalLongitude,
                                  y = decimalLatitude)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (GBIF):", nrow(gbif_neso))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

nigroplotgbif <- ggplot() +
  geom_pointdensity(data = gbif_nigro,
                    mapping = aes(x = decimalLongitude,
                                  y = decimalLatitude)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (GBIF):", nrow(gbif_nigro))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

rosplotgbif <- ggplot() +
  geom_pointdensity(data = gbif_ros,
                    mapping = aes(x = decimalLongitude,
                                  y = decimalLatitude)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (GBIF):", nrow(gbif_ros))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

rubplotgbif <- ggplot() +
  geom_pointdensity(data = gbif_rub,
                    mapping = aes(x = decimalLongitude,
                                  y = decimalLatitude)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (GBIF):", nrow(gbif_rub))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

sepplotgbif <- ggplot() +
  geom_pointdensity(data = gbif_sep,
                    mapping = aes(x = decimalLongitude,
                                  y = decimalLatitude)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (GBIF):", nrow(gbif_sep))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

webplotgbif <- ggplot() +
  geom_pointdensity(data = gbif_web,
                    mapping = aes(x = decimalLongitude,
                                  y = decimalLatitude)) +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  scale_color_gradient(low = "orange", high = "blue") +
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (GBIF):", nrow(gbif_web))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )
```

## Saving graphs

```{r}
#combined
capcombined <- caplot + capplotgbif + plot_annotation(title = "Trichoglossus haematodus capistratus")
ggsave('trichoglossus_plots/capcombined.png', capcombined)

flavicombined <- flavicansplot + flaviplotgbif + plot_annotation(title = "Trichoglossus haematodus flavicans")
ggsave('trichoglossus_plots/flavicombined.png', flavicombined)

forstcombined <- forsteniplot + forstplotgbif + plot_annotation(title = "Trichoglossus haematodus forsteni")
ggsave('trichoglossus_plots/forstcombined.png', forstcombined)

fortcombined <- fortisplot + fortplotgbif + plot_annotation(title = "Trichoglossus haematodus fortis")
ggsave('trichoglossus_plots/fortcombined.png', fortcombined)

haemcombined <- haemplot + haemplotgbif + plot_annotation(title = "Trichoglossus haematodus haematodus")
ggsave('trichoglossus_plots/haemcombined.png', haemcombined)

nonehaemcombined <- noneplot + haemplotgbif + plot_annotation(title = "T. haematodus, T.h. haematodus")
ggsave('trichoglossus_plots/nonehaemcombined.png', haemcombined)

intcombined <- intplot + intplotgbif + plot_annotation(title = "Trichoglossus haematodus intermedius")
ggsave('trichoglossus_plots/intcombined.png', intcombined)

masscombined <- massplot + massplotgbif + plot_annotation(title = "Trichoglossus haematodus massena")
ggsave('trichoglossus_plots/masscombined.png', masscombined)

microcombined <- microplot + microplotgbif + plot_annotation(title = "Trichoglossus haematodus micropteryx")
ggsave('trichoglossus_plots/microcombined.png', microcombined)

molcombined <- molplot + molplotgbif + plot_annotation(title = "Trichoglossus haematodus moluccanus")
ggsave('trichoglossus_plots/molcombined.png', molcombined)

roscombined <- rosplot + rosplotgbif + plot_annotation(title = "Trichoglossus haematodus rosenbergii")
ggsave('trichoglossus_plots/roscombined.png', roscombined)

rubcombined <- rubplot + rubplotgbif + plot_annotation(title = "Trichoglossus haematodus rubritorquis")
ggsave('trichoglossus_plots/rubcombined.png', rubcombined)

webcombined <- webplot + webplotgbif + plot_annotation(title = "Trichoglossus haematodus weberi")
ggsave('trichoglossus_plots/webcombined.png', webcombined)

caenigrocombined <- caerulicepsplot + nigroplotgbif + plot_annotation(title = "T. h. caeruliceps, T.h. nigrogularis")
ggsave('trichoglossus_plots/caenigrocombined.png', caenigrocombined)



  
#separate
ggsave('trichoglossus_plots/molxrub.png', molxrubplot + plot_annotation(title = "Trichoglossus moluccanus x rubritorquis"))

ggsave('trichoglossus_plots/nomhaem.png', nomhaemplot + plot_annotation(title = "Trichoglossus haematodus nominate haematodus"))

ggsave('trichoglossus_plots/caeruliceps.png', caerulicepsplot + plot_annotation(title = "Trichoglossus haematodus caeruliceps"))

ggsave('trichoglossus_plots/deplanchii.png', depplotgbif + plot_annotation(title = "Trichoglossus haematodus deplanchii"))

ggsave('trichoglossus_plots/djampeanus.png', djamplotgbif + plot_annotation(title = "Trichoglossus haematodus djampeanus"))

ggsave('trichoglossus_plots/mitchellii.png', mitchplotgbif + plot_annotation(title = "Trichoglossus haematodus mitchellii"))

ggsave('trichoglossus_plots/flavotectus.png', flavoplotgbif + plot_annotation(title = "Trichoglossus haematodus flavotectus"))

ggsave('trichoglossus_plots/nesophilus.png', nesoplotgbif + plot_annotation(title = "Trichoglossus haematodus nesophilus"))

ggsave('trichoglossus_plots/nigrogularis.png', nigroplotgbif + plot_annotation(title = "Trichoglossus haematodus nigrogularis"))

ggsave('trichoglossus_plots/septentrionalis.png', sepplotgbif + plot_annotation(title = "Trichoglossus haematodus septentrionalis"))

ggsave('trichoglossus_plots/sp_capistratus.png', spcapplot + plot_annotation(title = "Trichoglossus capistratus"))

ggsave('trichoglossus_plots/sp_forsteni.png', spforstplot + plot_annotation(title = "Trichoglossus forsteni"))

ggsave('trichoglossus_plots/sp_haematodus.png', sphaemplot + plot_annotation(title = "Trichoglossus haematodus"))

ggsave('trichoglossus_plots/sp_moluccanus.png', spmolplot + plot_annotation(title = "Trichoglossus moluccanus"))

ggsave('trichoglossus_plots/sp_rubritorquis.png', sprubplot + plot_annotation(title = "Trichoglossus rubritorquis"))

ggsave('trichoglossus_plots/sp_weberi.png', spwebplot + plot_annotation(title = "Trichoglossus weberi"))

```

## GBIF all, for species with humans observations or no preserved specimens or otherwise not covered by Schodde

```{r}
library(rnaturalearth)
library(tidyverse) 
library(here)
library(rmapshaper)
library(ggpointdensity)
library(viridis)
library(concaveman) 
library(cowplot)
library(patchwork)
library(sf) 
library(ggplot2)
library(scales)

tri_all <- read.delim("GBIF/gbif_trichoglossus_haematodus_all/trichoglossus_haematodus_gbif_all.csv")

tri_all <- tri_all[complete.cases(tri_all$decimalLatitude, tri_all$decimalLongitude), ]

table(tri_all$infraspecificEpithet)

eyrei <- filter(tri_all, infraspecificEpithet == "eyrei")


filename <- ne_download(scale = 10, 
                        type = "countries",
                        returnclass = "sf",
                        destdir = "shapefiles",
                        load = FALSE)

shapefile <- paste0("shapefiles/", filename, ".shp") |>
  st_read()

eyreiplot <- ggplot() +
    geom_point(data = eyrei, mapping = aes(x = decimalLongitude,
                                         y = decimalLatitude), colour = "orange") +
  geom_sf(data = shapefile, colour = "darkgrey", fill = NA) +  
  coord_sf(xlim = c(90, 185), ylim = c(-45, 10)) +
  guides(alpha = "none",
         colour = guide_colorbar(title = "Density")) +
    labs(subtitle = paste("Number of observations (GBIF):", nrow(eyrei))) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.justification = "left"
        )

ggsave('trichoglossus_plots/eyrei.png', eyreiplot + plot_annotation(title = "Trichoglossus haematodus eyrei"))
```
